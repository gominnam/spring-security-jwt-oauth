<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JWT 로그인 및 회원가입 예제</title>
</head>
<body>
<h1>JWT 로그인 및 회원가입</h1>

<!-- 로그인 폼 -->
<form id="loginForm">
    <label for="loginUsername">사용자명:</label>
    <input type="text" id="loginUsername" name="loginUsername" required><br>
    <label for="loginPassword">비밀번호:</label>
    <input type="password" id="loginPassword" name="loginPassword" required><br>
    <button type="button" onclick="login()">로그인</button>
    <button type="button" onclick="showSignupForm()">회원가입</button>
    <button type="button" onclick="showOauth2Form()">소셜로그인</button>
</form>

<!-- 회원가입 폼 -->
<div id="signupForm" style="display:none">
    <h2>회원가입</h2>
    <form id="registerForm">
        <label for="signupEmail">이메일:</label>
        <input type="text" id="signupEmail" name="signupEmail" required><br>
        <label for="signupUsername">사용자명:</label>
        <input type="text" id="signupUsername" name="signupUsername" required><br>
        <label for="signupPassword">비밀번호:</label>
        <input type="password" id="signupPassword" name="signupPassword" required><br>
        <button type="button" onclick="register()">회원가입</button>
    </form>
</div>

<div id="oauthLogInForm" style="display:none">
    <h2>소셜 로그인</h2>
    <button type="button" onclick="googleLogIn()">구글 로그인</button>
    <button type="button" onclick="naverLogIn()">네이버 로그인</button>
</div>

<!-- 토큰 표시 -->
<div id="tokenDisplay" style="display:none">
    <h2>받아온 JWT 토큰</h2>
    <pre id="jwtToken"></pre>
</div>

<script>
    async function login() {
        // 토큰을 표시하고, 로그인 폼을 감춤
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("tokenDisplay").style.display = "block";
        document.getElementById("oauthLogInForm").style.display = "none";

        const username = document.getElementById("loginUsername").value;
        const password = document.getElementById("loginPassword").value;

        if (username.length < 2) {
            alert("사용자명은 2글자 이상이어야 합니다.")
            return false;
        }

        if (password.length < 4) {
            alert("비밀번호는 4글자 이상이어야 합니다.")
            return false;
        }

        try {
            const response = await fetch('/api/auth/authenticate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({username, password}),
            });

            if (response.ok) { //redirected
                // const data = await response.json();
                // const accessToken = data.token; // 토큰 추출
                const accessToken = response.headers.get('Authorization');
                localStorage.setItem('accessToken', accessToken);

                const redirectUrl = response.headers.get('Location');

                // 리다이렉션 수행
                window.location.href = redirectUrl;

                // fetch(redirectUrl, {
                //     method: 'GET',
                //     headers: {
                //         'Authorization': accessToken,
                //     },
                // })
                //     .then(response => {
                //         if (!response.ok) {
                //             console.error('서버 응답 에러:', response.status);
                //         }
                //     })
                //     .catch(error => {
                //         console.error('에러 발생:', error);
                //     });
            } else {
                console.error('로그인 실패');
            }
        } catch (error) {
            console.error('에러 발생:', error);
        }
    }

    function showSignupForm() {
        // 회원가입 폼 표시
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("signupForm").style.display = "block";
        document.getElementById("oauthLogInForm").style.display = "none";
    }

    async function register() {
        // 회원가입 로직 구현
        const email = document.getElementById("signupEmail").value;
        const username = document.getElementById("signupUsername").value;
        const password = document.getElementById("signupPassword").value;

        if (!validateEmail(email)) {
            alert("유효한 이메일 주소를 입력하세요.")
            return false;
        }
        if (username.length < 2) {
            alert("사용자명은 2글자 이상이어야 합니다.")
            return false;
        }
        if (password.length < 4) {
            alert("비밀번호는 4글자 이상이어야 합니다.")
            return false;
        }

        try {
            const response = await fetch('/api/auth/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({email, username, password}),
            });

            if (response.ok) {//code == 201
                alert('회원가입 성공! 로그인 페이지로 이동합니다.');

                window.location.href = '/api/view/home';
            } else {
                console.error('회원가입 실패');
            }
        } catch (error) {
            console.error('에러 발생:', error);
        }

        return false;
    }

    function showOauth2Form() {
        // 소셜 로그인 폼 표시
        document.getElementById("oauthLogInForm").style.display = "block";
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("signupForm").style.display = "none";
    }

    function validateEmail(email) {
        // 간단한 이메일 유효성 검사를 위한 정규 표현식 사용
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }
</script>
</body>
</html>
